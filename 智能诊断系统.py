# æ•™æ¡ˆè¯Šæ–­ç³»ç»Ÿ.py
import os
import re
import streamlit as st
from zhipuai import ZhipuAI  # æ™ºè°±GLM-4åº“
import json
# ---------------------- 1. é…ç½®å¤§æ¨¡å‹ï¼ˆæ™ºè°±GLM-4ï¼‰----------------------
API_KEY = st.secrets["api_key"]
client = ZhipuAI(api_key=API_KEY)

# ---------------------- 2. å¤§æ¨¡å‹è°ƒç”¨å‡½æ•°----------------------
def model_invocation(prompt):
    """ç”¨æ™ºè°±GLM-4åˆ†ææ•™æ¡ˆï¼Œè¿”å›è§£æåçš„å­—å…¸"""
    try:
        response = client.chat.completions.create(
            model="glm-4",  # ä¸­æ–‡èƒ½åŠ›å¼ºçš„æ¨¡å‹
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,  # ä½æ¸©åº¦=ç»“æœç¨³å®š
            max_tokens=2000,
            response_format={"type": "json_object"}  # å¼ºåˆ¶è¿”å›JSONæ ¼å¼
        )
        content = response.choices[0].message.content
        return json.loads(content)  # å°†JSONå­—ç¬¦ä¸²è½¬ä¸ºå­—å…¸
    except json.JSONDecodeError:
        return {"error": "å¤§æ¨¡å‹è¿”å›å†…å®¹ä¸æ˜¯åˆæ³•JSONæ ¼å¼"}
    except Exception as e:
        return {"error": f"è°ƒç”¨å¤§æ¨¡å‹å¤±è´¥ï¼š{str(e)}"}

# ---------------------- 3. æ•™æ¡ˆæ£€æµ‹æ ¸å¿ƒåŠŸèƒ½----------------------
def test_lesson_plan(text):
    """è°ƒç”¨å¤§æ¨¡å‹æ£€æµ‹3ä¸ªç»´åº¦"""
    prompt = f"""
    ä½ æ˜¯åˆä¸­ä¿¡æ¯ç§‘æŠ€æ•™æ¡ˆè¯Šæ–­ä¸“å®¶ï¼Œåˆ†æä»¥ä¸‹æ•™æ¡ˆï¼Œè¾“å‡º3éƒ¨åˆ†ç»“æœï¼š
 1. æ•™å­¦ç¯èŠ‚å®Œæ•´æ€§ï¼ˆæ€»åˆ†100åˆ†ï¼Œ100=å®Œå…¨åˆæ ¼ï¼‰
    æ£€æŸ¥é¡¹ï¼šå¿…é¡»åŒ…å«ã€å¯¼å…¥ã€æ–°æˆã€ç»ƒä¹ ã€æ€»ç»“ã€ä½œä¸šã€‘5ä¸ªç¯èŠ‚ï¼Œæ¯ä¸ªç¯èŠ‚éœ€æ»¡è¶³ï¼š  
     å­˜åœ¨æ€§ï¼šç¯èŠ‚åç§°æ˜ç¡®ï¼ˆå¦‚â€œå¯¼å…¥â€â€œæ–°æˆâ€ç­‰ï¼Œå«å˜ä½“å¦‚â€œå¼•å…¥â€â€œè®²è§£â€éœ€æ˜ å°„åˆ°æ ‡å‡†ç¯èŠ‚ï¼‰ï¼›  
     å†…å®¹æœ‰æ•ˆæ€§ï¼šç¯èŠ‚æè¿°â‰¥30å­—ï¼Œä¸”å«å…·ä½“æ“ä½œï¼ˆå¦‚â€œå¯¼å…¥ç”¨å¾®ä¿¡çº¢åŒ…æ¡ˆä¾‹æé—®â€è€Œéâ€œå¯¼å…¥æ–°è¯¾â€ï¼‰ã€‚  
    è¯„åˆ†é€»è¾‘ï¼š  
     æ¯ç¼ºå¤±1ä¸ªç¯èŠ‚æ‰£20åˆ†ï¼ˆ5ç¯èŠ‚å…¨ç¼ºå¤±å¾—0åˆ†ï¼‰ï¼›  
     æ¯æœ‰1ä¸ªç¯èŠ‚å†…å®¹æ— æ•ˆï¼ˆå­—æ•°ä¸è¶³æˆ–æ— å…·ä½“æ“ä½œï¼‰æ‰£10åˆ†ï¼›  
     æ‰£å®Œä¸ºæ­¢ï¼Œæœ€ä½0åˆ†ã€‚  
    è¾“å‡ºå­—æ®µï¼š  
     'score'ï¼šæœ€ç»ˆå¾—åˆ†ï¼ˆ0-100ï¼‰ï¼›  
     'è¯¦æƒ…'ï¼šæ–‡å­—æè¿°æ‰£åˆ†åŸå› ï¼ˆå¦‚â€œç¼ºå¤±â€˜ä½œä¸šâ€™ç¯èŠ‚ï¼Œæ‰£20åˆ†ï¼›â€˜ç»ƒä¹ â€™ç¯èŠ‚å†…å®¹ä»…20å­—ï¼Œæ‰£10åˆ†â€ï¼‰ï¼›  
     'ç¼ºå¤±ç¯èŠ‚'ï¼šç¼ºå¤±çš„æ ‡å‡†ç¯èŠ‚åç§°åˆ—è¡¨ï¼ˆå¦‚["ä½œä¸š", "æ€»ç»“"]ï¼‰ï¼›  
     'å„ç¯èŠ‚çŠ¶æ€'ï¼šæ¯ä¸ªç¯èŠ‚çš„çŠ¶æ€åˆ—è¡¨ï¼Œå«ï¼š  
     'ç¯èŠ‚'ï¼šæ ‡å‡†ç¯èŠ‚åï¼ˆå¦‚â€œå¯¼å…¥â€ï¼‰ï¼›  
     'æ˜¯å¦å­˜åœ¨'ï¼štrue/falseï¼ˆåç§°æ˜¯å¦æ˜ç¡®ï¼‰ï¼›  
     'å†…å®¹æœ‰æ•ˆ'ï¼štrue/falseï¼ˆå­—æ•°â‰¥30å­—ä¸”æœ‰å…·ä½“æ“ä½œï¼‰ï¼›  
     'æ‘˜è¦'ï¼šç¯èŠ‚æ ¸å¿ƒå†…å®¹æ¦‚æ‹¬ï¼ˆâ‰¤50å­—ï¼‰ã€‚

2. æ—¶é—´åˆ†é…åˆç†æ€§ï¼ˆæ€»åˆ†100åˆ†ï¼Œ100=å®Œå…¨åˆç†ï¼‰
    æ£€æŸ¥é¡¹ï¼šæ€»è¯¾æ—¶40åˆ†é’Ÿï¼Œå„ç¯èŠ‚å‚è€ƒæ—¶é•¿ï¼š  
      å¯¼å…¥ï¼š3Â±2åˆ†é’Ÿï¼ˆ3-5åˆ†é’Ÿï¼‰ï¼›æ–°æˆï¼š15Â±5åˆ†é’Ÿï¼ˆ15-20åˆ†é’Ÿï¼‰ï¼›  
      ç»ƒä¹ ï¼š12Â±3åˆ†é’Ÿï¼ˆ8-15åˆ†é’Ÿï¼‰ï¼›æ€»ç»“ï¼š3Â±1åˆ†é’Ÿï¼ˆ2-4åˆ†é’Ÿï¼‰ï¼›ä½œä¸šï¼š2Â±1åˆ†é’Ÿï¼ˆ1-3åˆ†é’Ÿï¼‰ã€‚  
    è¯„åˆ†é€»è¾‘ï¼š  
      æ¯æœ‰1ä¸ªç¯èŠ‚æ—¶é•¿è¶…å‡ºå‚è€ƒèŒƒå›´æ‰£15åˆ†ï¼›  
      æ€»æ—¶é•¿ï¼ˆå„ç¯èŠ‚ä¹‹å’Œï¼‰è¶…å‡º40Â±5åˆ†é’Ÿï¼ˆ40-45åˆ†é’Ÿï¼‰æ‰£20åˆ†ï¼›  
      æ‰£å®Œä¸ºæ­¢ï¼Œæœ€ä½0åˆ†ã€‚  
    è¾“å‡ºå­—æ®µï¼š  
     'score'ï¼šæœ€ç»ˆå¾—åˆ†ï¼ˆ0-100ï¼‰ï¼›  
     'å»ºè®®'ï¼šæ¯ä¸ªç¯èŠ‚çš„å»ºè®®åˆ—è¡¨ï¼Œå«ï¼š  
     'ç¯èŠ‚'ï¼šæ ‡å‡†ç¯èŠ‚åï¼›  
     'å»ºè®®æ—¶é•¿'ï¼šå‚è€ƒèŒƒå›´ï¼ˆå¦‚â€œ3-7åˆ†é’Ÿâ€ï¼‰ï¼›  
     'æ˜¯å¦åˆç†'ï¼štrue/falseï¼ˆå½“å‰æ—¶é•¿æ˜¯å¦åœ¨èŒƒå›´å†…ï¼‰ã€‚

3. æ ¸å¿ƒç´ å…»åŒ¹é…åº¦ï¼ˆæ€»åˆ†100åˆ†ï¼Œ100=å®Œå…¨åŒ¹é…ï¼‰
    æ£€æŸ¥é¡¹ï¼šè¯„ä¼°4å¤§æ ¸å¿ƒç´ å…»çš„è¦†ç›–åº¦ï¼Œæ¯ä¸ªç´ å…»éœ€å«å…·ä½“æ•™å­¦è¡Œä¸ºï¼ˆå¦‚â€œä¿¡æ¯æ„è¯†â€éœ€æœ‰â€œè¾¨æä¿¡æ¯çœŸä¼ªâ€æ´»åŠ¨ï¼Œâ€œè®¡ç®—æ€ç»´â€éœ€æœ‰â€œç®—æ³•è®¾è®¡â€æ­¥éª¤ï¼‰ã€‚  
    è¯„åˆ†é€»è¾‘ï¼š  
    æ¯ä¸ªç´ å…»å•ç‹¬è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰ï¼Œ4ä¸ªç´ å…»å¹³å‡åˆ†ä½œä¸º`avg_score`ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼‰ï¼›  
    æ— å…·ä½“è¡Œä¸ºæè¿°åˆ™è¯¥ç´ å…»å¾—0åˆ†ã€‚  
    è¾“å‡ºå­—æ®µï¼š  
     'avg_score'ï¼š4ä¸ªç´ å…»çš„å¹³å‡åˆ†ï¼ˆ0-100ï¼‰ï¼›  
     'å„ç´ å…»'ï¼šæ¯ä¸ªç´ å…»çš„è¯¦ç»†è¯„åˆ†ï¼Œå«ï¼š  
     'ä¿¡æ¯æ„è¯†'/'è®¡ç®—æ€ç»´'/'æ•°å­—åŒ–å­¦ä¹ ä¸åˆ›æ–°'/'ä¿¡æ¯ç¤¾ä¼šè´£ä»»'ï¼š  
     'åˆ†æ•°'ï¼šè¯¥ç´ å…»å¾—åˆ†ï¼ˆ0-100ï¼‰ï¼›  
     'ç†ç”±'ï¼šè¯„åˆ†ä¾æ®ï¼ˆå¦‚â€œå«â€˜ç”¨æ€ç»´å¯¼å›¾æ¢³ç†ç½‘ç»œè°£è¨€ç±»å‹â€™æ´»åŠ¨ï¼Œè¦†ç›–ä¿¡æ¯è¾¨æèƒ½åŠ›â€ï¼‰ã€‚
    è¾“å‡ºä¸¥æ ¼JSONæ ¼å¼ï¼š
    {{
    "ç¯èŠ‚å®Œæ•´æ€§": {{
        "score": 80,
        "è¯¦æƒ…": "ç¼ºå¤±'ä½œä¸š'ç¯èŠ‚æ‰£20åˆ†ï¼Œ'ç»ƒä¹ 'ç¯èŠ‚å†…å®¹ä»…25å­—æ‰£10åˆ†",
        "ç¼ºå¤±ç¯èŠ‚": ["ä½œä¸š"],
        "å„ç¯èŠ‚çŠ¶æ€": [
            {{"ç¯èŠ‚": "å¯¼å…¥", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "ç”¨å¾®ä¿¡çº¢åŒ…æ¡ˆä¾‹æé—®æ•°æ®æ¦‚å¿µ"}},
            {{"ç¯èŠ‚": "æ–°æˆ", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "è®²è§£å˜é‡å®šä¹‰ä¸æ•°æ®ç±»å‹ï¼Œæ¼”ç¤ºèµ‹å€¼æ“ä½œ"}},
            {{"ç¯èŠ‚": "ç»ƒä¹ ", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": false, "æ‘˜è¦": "å®Œæˆæ•™æç»ƒä¹ 1-3"}},
            {{"ç¯èŠ‚": "æ€»ç»“", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "å›é¡¾å˜é‡å‘½åè§„åˆ™ä¸æ•°æ®ç±»å‹"}},
            {{"ç¯èŠ‚": "ä½œä¸š", "æ˜¯å¦å­˜åœ¨": false, "å†…å®¹æœ‰æ•ˆ": false, "æ‘˜è¦": ""}}
        ]
    }},
    "æ—¶é—´åˆ†é…": {{
        "score": 70,
        "å»ºè®®": [
            {{"ç¯èŠ‚": "å¯¼å…¥", "å»ºè®®æ—¶é•¿": "3-7åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
            {{"ç¯èŠ‚": "æ–°æˆ", "å»ºè®®æ—¶é•¿": "20-30åˆ†é’Ÿ", "æ˜¯å¦åˆç†": false}},
            {{"ç¯èŠ‚": "ç»ƒä¹ ", "å»ºè®®æ—¶é•¿": "7-13åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
            {{"ç¯èŠ‚": "æ€»ç»“", "å»ºè®®æ—¶é•¿": "2-4åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
            {{"ç¯èŠ‚": "ä½œä¸š", "å»ºè®®æ—¶é•¿": "1-3åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}}
        ]
    }},
    "ç´ å…»åŒ¹é…": {{
        "avg_score": 82.5,
        "å„ç´ å…»": {{
            "ä¿¡æ¯æ„è¯†": {{"åˆ†æ•°": 85, "ç†ç”±": "å«'è¾¨æç½‘ç»œè°£è¨€'æ¡ˆä¾‹ï¼ŒåŸ¹å…»ä¿¡æ¯çœŸä¼ªåˆ¤æ–­èƒ½åŠ›"}},
            "è®¡ç®—æ€ç»´": {{"åˆ†æ•°": 80, "ç†ç”±": "ç”¨æµç¨‹å›¾è®¾è®¡æ’åºç®—æ³•ï¼Œè¦†ç›–é—®é¢˜æ‹†è§£ä¸é€»è¾‘è¡¨è¾¾"}},
            "æ•°å­—åŒ–å­¦ä¹ ä¸åˆ›æ–°": {{"åˆ†æ•°": 85, "ç†ç”±": "å°ç»„åˆä½œå¼€å‘Pythonå°æ¸¸æˆï¼Œä½“ç°å·¥å…·åº”ç”¨ä¸åˆ›æ–°"}},
            "ä¿¡æ¯ç¤¾ä¼šè´£ä»»": {{"åˆ†æ•°": 80, "ç†ç”±": "è®¨è®ºä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•è§„ï¼Œå¼ºåŒ–ä¼¦ç†æ„è¯†"}}
        }}
    }}
}}
    }}

    æ•™æ¡ˆæ–‡æœ¬ï¼š{text}
    """
    return model_invocation(prompt)

def score_lesson_plan(diagnosis_result):
    """æŒ‰æƒé‡è®¡ç®—ä¸‰ä¸ªç»´åº¦çš„æ€»åˆ†"""
    try:
        # å®‰å…¨è·å–åˆ†æ•°å€¼ï¼ˆé¿å…KeyErrorï¼‰
        section_score = diagnosis_result.get("ç¯èŠ‚å®Œæ•´æ€§", {}).get("score", 0)
        time_score = diagnosis_result.get("æ—¶é—´åˆ†é…", {}).get("score", 0)
        literacy_score = diagnosis_result.get("ç´ å…»åŒ¹é…", {}).get("avg_score", 0)  # ä¿®æ­£æ‹¼å†™ï¼šsocre -> score

        # åŠ æƒè®¡ç®—ï¼šç¯èŠ‚30% + æ—¶é—´30% + ç´ å…»40%
        total_score = section_score * 0.3 + time_score * 0.3 + literacy_score * 0.4
        return round(total_score, 2)  # ä¿ç•™2ä½å°æ•°
    except Exception as e:
        st.error(f"è¯„åˆ†è®¡ç®—å¤±è´¥: {str(e)}")
        return 0.0
# ---------------------- 4. å›¾å½¢åŒ–ç•Œé¢ï¼ˆä¸Šä¼ +æ˜¾ç¤ºç»“æœï¼‰----------------------
def Main_interface():
    st.set_page_config(page_title="æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ", layout="wide")
    st.title("ğŸ“š åˆä¸­ä¿¡æ¯ç§‘æŠ€æ•™æ¡ˆæ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ")
    st.write("ä¸Šä¼ TXTæ•™æ¡ˆæ–‡ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹è§„èŒƒæ€§å¹¶ç”Ÿæˆå»ºè®®ï¼")

    # ä¸Šä¼ æ–‡ä»¶ï¼ˆä»…æ”¯æŒTXTï¼Œé¿å…PDFä¹±ç ï¼‰
    File_Upload = st.file_uploader("é€‰æ‹©æ•™æ¡ˆæ–‡ä»¶ï¼ˆTXTæ ¼å¼ï¼‰", type=["txt"], key="uploader")

    if File_Upload:
        # è¯»å–TXTå†…å®¹ï¼ˆUTF-8ç¼–ç é˜²ä¹±ç ï¼‰
        try:
            text = File_Upload.read().decode("utf-8")
        except:
            st.error("æ–‡ä»¶ç¼–ç é”™è¯¯ï¼è¯·ç”¨è®°äº‹æœ¬æ‰“å¼€æ•™æ¡ˆï¼Œå¦å­˜ä¸ºUTF-8æ ¼å¼TXT")
            return

        if len(text.strip()) < 100:
            st.warning("æ•™æ¡ˆå†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½æ— æ³•å‡†ç¡®æ£€æµ‹ï¼")
            return

        # è°ƒç”¨æ£€æµ‹åŠŸèƒ½
        with st.spinner("å¤§æ¨¡å‹åˆ†æä¸­...ï¼ˆçº¦10ç§’ï¼‰"):
            result = test_lesson_plan(text)

        # æ˜¾ç¤ºç»“æœ
        st.subheader("ğŸ“Š è¯Šæ–­ç»“æœï¼ˆJSONæ ¼å¼ï¼‰")
        st.json(result)  # ç»“æ„åŒ–å±•ç¤º
        # è®¡ç®—æ€»åˆ†
        total_score = score_lesson_plan(result)
        # æå–å„ç»´åº¦åˆ†æ•°
        section_score = result.get("ç¯èŠ‚å®Œæ•´æ€§", {}).get("score", 0)
        time_score = result.get("æ—¶é—´åˆ†é…", {}).get("score", 0)
        literacy_score = result.get("ç´ å…»åŒ¹é…", {}).get("avg_score", 0)
        # æ˜¾ç¤ºåˆ†æ•°å¡ç‰‡
        st.subheader("ğŸ“ˆ æ•™æ¡ˆè¯„åˆ†")

        # åˆ›å»ºåˆ†æ•°å¡ç‰‡å¸ƒå±€
        col1, col2, col3, col4 = st.columns(4)

        # ç¯èŠ‚å®Œæ•´æ€§å¡ç‰‡
        col1.metric(
            label="ç¯èŠ‚å®Œæ•´æ€§",
            value=f"{section_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°å¯¼å…¥/æ–°æˆ/ç»ƒä¹ /æ€»ç»“/ä½œä¸š5ç¯èŠ‚æ˜¯å¦é½å…¨æœ‰æ•ˆ"
        )

        # æ—¶é—´åˆ†é…å¡ç‰‡
        col2.metric(
            label="æ—¶é—´åˆ†é…",
            value=f"{time_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°å„ç¯èŠ‚æ—¶é•¿æ˜¯å¦ç¬¦åˆ45åˆ†é’Ÿè¯¾ç¨‹è¦æ±‚"
        )

        # æ ¸å¿ƒç´ å…»å¡ç‰‡
        col3.metric(
            label="æ ¸å¿ƒç´ å…»",
            value=f"{literacy_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°ä¿¡æ¯æ„è¯†/è®¡ç®—æ€ç»´ç­‰å››å¤§ç´ å…»è¦†ç›–åº¦"
        )

        # æ€»åˆ†å¡ç‰‡ï¼ˆçªå‡ºæ˜¾ç¤ºï¼‰
        col4.metric(
            label="ğŸ† æ•™æ¡ˆæ€»åˆ†",
            value=f"{total_score}åˆ†",
            help="åŠ æƒè®¡ç®—ï¼šç¯èŠ‚30% + æ—¶é—´30% + ç´ å…»40%"
        )

        # æ·»åŠ è¿›åº¦æ¡å¯è§†åŒ–
        st.progress(int(total_score), text=f"æ•™æ¡ˆç»¼åˆè¯„åˆ†ï¼š{total_score}/100åˆ†")

        # ç”Ÿæˆæ–‡å­—å»ºè®®
        suggestions = f"æ ¹æ®è¯Šæ–­ç»“æœ{result}ï¼Œç»™è€å¸ˆå†™3æ¡å…·ä½“ä¿®æ”¹å»ºè®®ï¼ˆç®€æ´æ˜äº†ï¼‰ï¼š"
        text_suggestions = model_invocation(suggestions)
        st.subheader("ğŸ’¡ è€å¸ˆä¿®æ”¹å»ºè®®")
        st.info(text_suggestions)  # è“è‰²èƒŒæ™¯çªå‡ºæ˜¾ç¤º


# ---------------------- è¿è¡Œç•Œé¢ ----------------------
if __name__ == "__main__":
    Main_interface()  # å¯åŠ¨å›¾å½¢ç•Œé¢