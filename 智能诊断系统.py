# æ•™æ¡ˆè¯Šæ–­ç³»ç»Ÿ.py
import os
import re
import streamlit as st
from zhipuai import ZhipuAI  # æ™ºè°±GLM-4åº“
import json
# ---------------------- 1. é…ç½®å¤§æ¨¡å‹ï¼ˆæ™ºè°±GLM-4ï¼‰----------------------
API_KEY = st.secrets["api_key"]
client = ZhipuAI(api_key=API_KEY)

# ---------------------- 2. å¤§æ¨¡å‹è°ƒç”¨å‡½æ•°----------------------
def model_invocation(prompt):
    """ç”¨æ™ºè°±GLM-4åˆ†ææ•™æ¡ˆï¼Œè¿”å›è§£æåçš„å­—å…¸ï¼Œå¢å¼ºå®¹é”™å¤„ç†"""
    try:
        response = client.chat.completions.create(
            model="glm-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
            max_tokens=2000
        )
        content = response.choices[0].message.content
        
        # ä¿å­˜åŸå§‹å“åº”ä»¥ä¾¿è°ƒè¯•
        raw_content = content
        
        # æ¸…æ´—1: å»é™¤ Markdown ä»£ç å—æ ‡è®° (```json ... ```)
        content = content.strip()
        if content.startswith("```"):
            # æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œå»æ‰ç¬¬ä¸€è¡Œ(```json)
            first_newline = content.find('\n')
            if first_newline != -1:
                content = content[first_newline+1:]
            # å»æ‰æœ«å°¾çš„ ```
            if content.endswith("```"):
                content = content[:-3].strip()
        
        # æ¸…æ´—2: æŸ¥æ‰¾ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª } ä¹‹é—´çš„å†…å®¹ï¼ˆé˜²æ­¢å¼€å¤´æœ‰æ–‡å­—è¯´æ˜ï¼‰
        start_idx = content.find('{')
        end_idx = content.rfind('}')
        
        if start_idx != -1 and end_idx != -1 and end_idx > start_idx:
            content = content[start_idx:end_idx+1]
        
        # æ¸…æ´—3: å»é™¤é¦–å°¾ç©ºç™½
        content = content.strip()
        
        # å°è¯•è§£æ
        return json.loads(content)
        
    except json.JSONDecodeError as e:
        # å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œè¿”å›åŒ…å«åŸå§‹å†…å®¹çš„é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
        return {
            "error": "å¤§æ¨¡å‹è¿”å›å†…å®¹ä¸æ˜¯åˆæ³•JSONæ ¼å¼", 
            "è§£æé”™è¯¯": str(e),
            "åŸå§‹å†…å®¹å‰200å­—": raw_content[:200] if 'raw_content' in locals() else "æ— ",
            "æ¸…æ´—åå†…å®¹å‰200å­—": content[:200] if 'content' in locals() else "æ— "
        }
    except Exception as e:
        return {"error": f"è°ƒç”¨å¤§æ¨¡å‹å¤±è´¥ï¼š{str(e)}"}
# ---------------------- 3. æ•™æ¡ˆæ£€æµ‹æ ¸å¿ƒåŠŸèƒ½----------------------
def test_lesson_plan(text):
    """è°ƒç”¨å¤§æ¨¡å‹æ£€æµ‹3ä¸ªç»´åº¦"""
    prompt = f"""
ä½ æ˜¯åˆä¸­ä¿¡æ¯ç§‘æŠ€æ•™æ¡ˆè¯Šæ–­ä¸“å®¶ï¼Œåˆ†æä»¥ä¸‹æ•™æ¡ˆï¼Œè¾“å‡º3éƒ¨åˆ†ç»“æœï¼š

1. æ•™å­¦ç¯èŠ‚å®Œæ•´æ€§ï¼ˆæ€»åˆ†100åˆ†ï¼Œ100=å®Œå…¨åˆæ ¼ï¼‰
   æ£€æŸ¥é¡¹ï¼šå¿…é¡»åŒ…å«ã€å¯¼å…¥ã€æ–°æˆã€ç»ƒä¹ ã€æ€»ç»“ã€ä½œä¸šã€‘5ä¸ªç¯èŠ‚ï¼Œæ¯ä¸ªç¯èŠ‚éœ€æ»¡è¶³ï¼š  
   å­˜åœ¨æ€§ï¼šç¯èŠ‚åç§°æ˜ç¡®ï¼ˆå¦‚"å¯¼å…¥""æ–°æˆ"ç­‰ï¼Œå«å˜ä½“å¦‚"å¼•å…¥""è®²è§£"éœ€æ˜ å°„åˆ°æ ‡å‡†ç¯èŠ‚ï¼‰ï¼›  
   å†…å®¹æœ‰æ•ˆæ€§ï¼šç¯èŠ‚æè¿°â‰¥30å­—ï¼Œä¸”å«å…·ä½“æ“ä½œï¼ˆå¦‚"å¯¼å…¥ç”¨å¾®ä¿¡çº¢åŒ…æ¡ˆä¾‹æé—®"è€Œé"å¯¼å…¥æ–°è¯¾"ï¼‰ã€‚  
   è¯„åˆ†é€»è¾‘ï¼š  
   æ¯ç¼ºå¤±1ä¸ªç¯èŠ‚æ‰£20åˆ†ï¼ˆ5ç¯èŠ‚å…¨ç¼ºå¤±å¾—0åˆ†ï¼‰ï¼›  
   æ¯æœ‰1ä¸ªç¯èŠ‚å†…å®¹æ— æ•ˆï¼ˆå­—æ•°ä¸è¶³æˆ–æ— å…·ä½“æ“ä½œï¼‰æ‰£10åˆ†ï¼›  
   æ‰£å®Œä¸ºæ­¢ï¼Œæœ€ä½0åˆ†ã€‚  
   è¾“å‡ºå­—æ®µï¼š  
   'score'ï¼šæœ€ç»ˆå¾—åˆ†ï¼ˆ0-100ï¼‰ï¼›  
   'è¯¦æƒ…'ï¼šæ–‡å­—æè¿°æ‰£åˆ†åŸå› ï¼ˆå¦‚"ç¼ºå¤±'ä½œä¸š'ç¯èŠ‚ï¼Œæ‰£20åˆ†ï¼›'ç»ƒä¹ 'ç¯èŠ‚å†…å®¹ä»…20å­—ï¼Œæ‰£10åˆ†"ï¼‰ï¼›  
   'ç¼ºå¤±ç¯èŠ‚'ï¼šä»…åˆ—å‡ºå¾—0åˆ†çš„ç¯èŠ‚åç§°ï¼Œç¼ºå¤±çš„æ ‡å‡†ç¯èŠ‚åç§°åˆ—è¡¨ï¼ˆå¦‚["ä½œä¸š", "æ€»ç»“"]ï¼‰ï¼›  
   'å„ç¯èŠ‚çŠ¶æ€'ï¼šæ¯ä¸ªç¯èŠ‚çš„çŠ¶æ€åˆ—è¡¨ï¼Œå«ï¼š  
     'ç¯èŠ‚'ï¼šæ ‡å‡†ç¯èŠ‚åï¼ˆå¦‚"å¯¼å…¥"ï¼‰ï¼›  
     'å¾—åˆ†'ï¼š20/10/0
     'æ˜¯å¦å­˜åœ¨'ï¼štrue/falseï¼›  
     'å†…å®¹æœ‰æ•ˆ'ï¼štrue/falseï¼ˆä»…å½“å­˜åœ¨æ—¶åˆ¤æ–­ï¼Œå­—æ•°â‰¥30å­—ä¸”æœ‰å…·ä½“æ“ä½œï¼‰ï¼›  
     'æ‘˜è¦'ï¼šç¯èŠ‚æ ¸å¿ƒå†…å®¹æ¦‚æ‹¬ï¼ˆâ‰¤50å­—ï¼‰ã€‚

2. æ—¶é—´åˆ†é…åˆç†æ€§ï¼ˆæ€»åˆ†100åˆ†ï¼Œ100=å®Œå…¨åˆç†ï¼‰
   ä»…å¯¹ã€å®é™…å­˜åœ¨ã€‘çš„ç¯èŠ‚è¿›è¡Œæ—¶é—´è¯„ä¼°
   æ£€æŸ¥é¡¹ï¼šæ€»è¯¾æ—¶40åˆ†é’Ÿï¼Œå„ç¯èŠ‚å‚è€ƒæ—¶é•¿ï¼š  
   å¯¼å…¥ï¼š3-5åˆ†é’Ÿï¼ˆÂ±2åˆ†é’Ÿï¼‰â†’ åˆç†èŒƒå›´1-7åˆ†é’Ÿ
   æ–°æˆï¼š15-20åˆ†é’Ÿï¼ˆÂ±5åˆ†é’Ÿï¼‰â†’ åˆç†èŒƒå›´10-25åˆ†é’Ÿ  
   ç»ƒä¹ ï¼š8-15åˆ†é’Ÿï¼ˆÂ±3åˆ†é’Ÿï¼‰â†’ åˆç†èŒƒå›´5-18åˆ†é’Ÿ
   æ€»ç»“ï¼š2-4åˆ†é’Ÿï¼ˆÂ±1åˆ†é’Ÿï¼‰â†’ åˆç†èŒƒå›´1-5åˆ†é’Ÿ
   ä½œä¸šï¼š1-3åˆ†é’Ÿï¼ˆÂ±1åˆ†é’Ÿï¼‰â†’ åˆç†èŒƒå›´0-4åˆ†é’Ÿã€‚  
   è¯„åˆ†é€»è¾‘ï¼š  
   ç‰¹æ®Šè§„åˆ™ï¼šè‹¥ç¯èŠ‚ç¼ºå¤±ï¼ˆä¸Šè¿°ç¬¬1éƒ¨åˆ†åˆ¤å®šï¼‰ï¼Œ'æ˜¯å¦åˆç†'å¿…é¡»ä¸ºfalseï¼Œ'å»ºè®®æ—¶é•¿'æ ‡æ³¨"ç¯èŠ‚ç¼ºå¤±"
   æ¯æœ‰1ä¸ªç¯èŠ‚æ—¶é•¿è¶…å‡ºå‚è€ƒèŒƒå›´æ‰£15åˆ†ï¼›  
   æ€»æ—¶é•¿ï¼ˆå„ç¯èŠ‚ä¹‹å’Œï¼‰è¶…å‡º40Â±5åˆ†é’Ÿï¼ˆ35-45åˆ†é’Ÿï¼‰æ‰£20åˆ†ï¼›  
   æ‰£å®Œä¸ºæ­¢ï¼Œæœ€ä½0åˆ†ã€‚  
   è¾“å‡ºå­—æ®µï¼š  
   'score'ï¼šæœ€ç»ˆå¾—åˆ†ï¼ˆ0-100ï¼‰ï¼›  
   'å»ºè®®'ï¼šæ¯ä¸ªç¯èŠ‚çš„å»ºè®®åˆ—è¡¨ï¼Œå«ï¼š  
     'ç¯èŠ‚'ï¼šæ ‡å‡†ç¯èŠ‚åï¼›  
     'å½“å‰æ—¶é•¿'ï¼šä»æ•™æ¡ˆä¸­æå–çš„åˆ†é’Ÿæ•°ï¼ˆè‹¥ç¼ºå¤±åˆ™ä¸º0ï¼‰ï¼›
     'å»ºè®®æ—¶é•¿'ï¼šå‚è€ƒèŒƒå›´ï¼ˆå¦‚"3-7åˆ†é’Ÿ"ï¼‰æˆ–"ç¯èŠ‚ç¼ºå¤±"ï¼›  
     'æ˜¯å¦åˆç†'ï¼štrue/falseï¼ˆä»…å½“ç¯èŠ‚å­˜åœ¨ä¸”æ—¶é•¿åœ¨èŒƒå›´å†…æ—¶ä¸ºtrueï¼‰ã€‚

3. æ ¸å¿ƒç´ å…»åŒ¹é…åº¦ï¼ˆåŸºäºå‚ç…§æ¡ˆä¾‹çš„è¯­ä¹‰ç›¸ä¼¼åº¦åŠ æƒè®¡ç®—ï¼‰
   ã€ç®—æ³•è¯´æ˜ã€‘
   é‡‡ç”¨"é”šç‚¹å¯¹æ¯”æ³•"è®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦ï¼š
   - æ¯ä¸ªç´ å…»è®¾ç½®3ä¸ªå‚ç…§æ–‡æœ¬ï¼ˆé”šç‚¹ï¼‰ï¼šä¼˜ç§€Caseï¼ˆ90-100åˆ†æ¡£ï¼‰ã€åŸºç¡€Caseï¼ˆ60-80åˆ†æ¡£ï¼‰ã€ç¼ºå¤±Caseï¼ˆ0-30åˆ†æ¡£ï¼‰
   - å°†ç”¨æˆ·æ•™æ¡ˆä¸3ä¸ªé”šç‚¹è¿›è¡Œè¯­ä¹‰å¯¹æ¯”ï¼Œè®¡ç®—åŒ¹é…åº¦æƒé‡
   - æœ€ç»ˆå¾—åˆ† = ä¼˜ç§€é”šç‚¹åŒ¹é…åº¦Ã—0.5 + åŸºç¡€é”šç‚¹åŒ¹é…åº¦Ã—0.3 + ï¼ˆ1-ç¼ºå¤±é”šç‚¹åŒ¹é…åº¦ï¼‰Ã—0.2
   - ç»“æœæ˜ å°„åˆ°0-100åˆ†åŒºé—´ï¼Œä¿ç•™ä¸¤ä½å°æ•°

   ã€å››ç»´ç´ å…»å‚ç…§é”šç‚¹ã€‘ï¼ˆå°‘æ ·æœ¬å­¦ä¹ ç¤ºä¾‹ï¼‰
   
   ã€ä¿¡æ¯æ„è¯†ã€‘
   - ä¼˜ç§€é”šç‚¹ï¼ˆ95åˆ†ç‰¹å¾ï¼‰ï¼š"é€šè¿‡'ç½‘ç»œè°£è¨€è¾¨ä¸€è¾¨'æ´»åŠ¨ï¼Œå­¦ç”Ÿéœ€å¯¹æ¯”å®˜æ–¹åª’ä½“ä¸è‡ªåª’ä½“ä¿¡æ¯ï¼ŒéªŒè¯æ¥æºçœŸå®æ€§ï¼Œå¹¶è®°å½•åˆ¤æ–­ä¾æ®"
   - åŸºç¡€é”šç‚¹ï¼ˆ70åˆ†ç‰¹å¾ï¼‰ï¼š"å¼•å¯¼å­¦ç”Ÿè¾¨åˆ«ç½‘ç»œä¿¡æ¯çœŸä¼ªï¼ŒåŸ¹å…»ä¿¡æ¯ç”„åˆ«æ„è¯†"  
   - ç¼ºå¤±é”šç‚¹ï¼ˆ15åˆ†ç‰¹å¾ï¼‰ï¼š"å­¦ä¹ ä½¿ç”¨æœç´¢å¼•æ“"ï¼ˆä»…æŠ€èƒ½æ“ä½œï¼Œæ— ç´ å…»åŸ¹å…»ï¼‰
   
   ã€è®¡ç®—æ€ç»´ã€‘
   - ä¼˜ç§€é”šç‚¹ï¼ˆ95åˆ†ç‰¹å¾ï¼‰ï¼š"å°†åƒåœ¾åˆ†ç±»ä»»åŠ¡åˆ†è§£ä¸º'è¯†åˆ«-åˆ¤æ–­-å½’ç±»'ä¸‰æ­¥éª¤ï¼Œç»˜åˆ¶æµç¨‹å›¾ï¼Œå¹¶ç”¨è‡ªç„¶è¯­è¨€æè¿°ç®—æ³•é€»è¾‘"
   - åŸºç¡€é”šç‚¹ï¼ˆ70åˆ†ç‰¹å¾ï¼‰ï¼š"æŒ‰ç…§æ­¥éª¤å®Œæˆæ“ä½œï¼Œç†è§£é—®é¢˜è§£å†³çš„è¿‡ç¨‹"
   - ç¼ºå¤±é”šç‚¹ï¼ˆ15åˆ†ç‰¹å¾ï¼‰ï¼š"è®°ä½æ“ä½œæ­¥éª¤"ï¼ˆä»…è®°å¿†ï¼Œæ— æ€ç»´è¿‡ç¨‹ï¼‰
   
   ã€æ•°å­—åŒ–å­¦ä¹ ä¸åˆ›æ–°ã€‘
   - ä¼˜ç§€é”šç‚¹ï¼ˆ95åˆ†ç‰¹å¾ï¼‰ï¼š"å°ç»„åä½œä½¿ç”¨åœ¨çº¿æ–‡æ¡£å…±åŒç¼–è¾‘ç ”ç©¶æŠ¥å‘Šï¼Œæ’å…¥å¤šåª’ä½“ç´ æï¼Œå¹¶è¿›è¡Œåœ¨çº¿æ¼”ç¤ºåˆ†äº«"
   - åŸºç¡€é”šç‚¹ï¼ˆ70åˆ†ç‰¹å¾ï¼‰ï¼š"åˆ©ç”¨Wordåˆ¶ä½œç”µå­å°æŠ¥ï¼Œæ•´åˆç½‘ç»œèµ„æ–™"
   - ç¼ºå¤±é”šç‚¹ï¼ˆ15åˆ†ç‰¹å¾ï¼‰ï¼š"é˜…è¯»è¯¾æœ¬å†…å®¹"ï¼ˆæ— æ•°å­—åŒ–å·¥å…·åº”ç”¨ï¼‰
   
   ã€ä¿¡æ¯ç¤¾ä¼šè´£ä»»ã€‘
   - ä¼˜ç§€é”šç‚¹ï¼ˆ95åˆ†ç‰¹å¾ï¼‰ï¼š"è®¨è®ºAIæ¢è„¸æŠ€æœ¯çš„ä¼¦ç†è¾¹ç•Œï¼Œåˆ†æ'convenience vs privacy'çš„å†²çªï¼Œåˆ¶å®šä¸ªäººä¿¡æ¯ä¿æŠ¤å…¬çº¦"
   - åŸºç¡€é”šç‚¹ï¼ˆ70åˆ†ç‰¹å¾ï¼‰ï¼š"äº†è§£ç½‘ç»œå®‰å…¨çŸ¥è¯†ï¼Œä¸æ³„éœ²ä¸ªäººä¿¡æ¯"
   - ç¼ºå¤±é”šç‚¹ï¼ˆ15åˆ†ç‰¹å¾ï¼‰ï¼š"å­¦ä¹ è½¯ä»¶æ“ä½œæŠ€å·§"ï¼ˆæ— ä¼¦ç†è®¨è®ºï¼‰

   ã€è¯„åˆ†è®¡ç®—é€»è¾‘ã€‘
   å¯¹æ¯ä¸ªç´ å…»æ‰§è¡Œä»¥ä¸‹åˆ†ææ­¥éª¤ï¼š
   
   Step 1ï¼šåŒ¹é…åº¦è¯„ä¼°ï¼ˆåœ¨0-1ä¹‹é—´ï¼Œä¿ç•™ä¸¤ä½å°æ•°ï¼‰
   - ä¸ä¼˜ç§€é”šç‚¹çš„è¯­ä¹‰ç›¸ä¼¼åº¦ï¼š____ï¼ˆå¦‚0.85ï¼‰
   - ä¸åŸºç¡€é”šç‚¹çš„è¯­ä¹‰ç›¸ä¼¼åº¦ï¼š____ï¼ˆå¦‚0.60ï¼‰  
   - ä¸ç¼ºå¤±é”šç‚¹çš„è¯­ä¹‰ç›¸ä¼¼åº¦ï¼š____ï¼ˆå¦‚0.10ï¼‰
   
   Step 2ï¼šåŠ æƒè®¡ç®—ï¼ˆæƒé‡ï¼šä¼˜ç§€0.5ï¼ŒåŸºç¡€0.3ï¼Œç¼ºå¤±åå‘0.2ï¼‰
   åŸå§‹åˆ† = 0.85Ã—0.5 + 0.60Ã—0.3 + (1-0.10)Ã—0.2 = 0.425 + 0.18 + 0.18 = 0.785
   æ˜ å°„åˆ°ç™¾åˆ†åˆ¶ï¼š0.785 Ã— 100 = 78.50åˆ†
   
   Step 3ï¼šè¯æ®æå–ï¼ˆå¿…é¡»åˆ—å‡ºåŒ¹é…å…³é”®è¯ï¼‰
   - ä¼˜ç§€é”šç‚¹åŒ¹é…è¯ï¼š"å¯¹æ¯”ä¿¡æ¯æ¥æº"ã€"éªŒè¯çœŸå®æ€§"ï¼ˆæ¥è‡ªæ•™æ¡ˆç¬¬Xæ®µï¼‰
   - åŸºç¡€é”šç‚¹åŒ¹é…è¯ï¼š"è¾¨åˆ«çœŸä¼ª"ï¼ˆæ¥è‡ªæ•™æ¡ˆç›®æ ‡æè¿°ï¼‰
   - ç¼ºå¤±é”šç‚¹å·®å¼‚ï¼šæ•™æ¡ˆæœªæåŠ"è®°å½•åˆ¤æ–­ä¾æ®"ï¼ˆä¼˜ç§€é”šç‚¹ç‰¹æœ‰ï¼‰

   è¾“å‡ºä¸¥æ ¼JSONæ ¼å¼ï¼š
   {{
   "ç¯èŠ‚å®Œæ•´æ€§": {{
       "score": 80,
       "è¯¦æƒ…": "ç¼ºå¤±'ä½œä¸š'ç¯èŠ‚æ‰£20åˆ†ï¼Œ'ç»ƒä¹ 'ç¯èŠ‚å†…å®¹ä»…25å­—æ‰£10åˆ†",
       "ç¼ºå¤±ç¯èŠ‚": ["ä½œä¸š"],
       "å„ç¯èŠ‚çŠ¶æ€": [
           {{"ç¯èŠ‚": "å¯¼å…¥", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "ç”¨å¾®ä¿¡çº¢åŒ…æ¡ˆä¾‹æé—®æ•°æ®æ¦‚å¿µ"}},
           {{"ç¯èŠ‚": "æ–°æˆ", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "è®²è§£å˜é‡å®šä¹‰ä¸æ•°æ®ç±»å‹ï¼Œæ¼”ç¤ºèµ‹å€¼æ“ä½œ"}},
           {{"ç¯èŠ‚": "ç»ƒä¹ ", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": false, "æ‘˜è¦": "å®Œæˆæ•™æç»ƒä¹ 1-3"}},
           {{"ç¯èŠ‚": "æ€»ç»“", "æ˜¯å¦å­˜åœ¨": true, "å†…å®¹æœ‰æ•ˆ": true, "æ‘˜è¦": "å›é¡¾å˜é‡å‘½åè§„åˆ™ä¸æ•°æ®ç±»å‹"}},
           {{"ç¯èŠ‚": "ä½œä¸š", "æ˜¯å¦å­˜åœ¨": false, "å†…å®¹æœ‰æ•ˆ": false, "æ‘˜è¦": ""}}
       ]
   }},
   "æ—¶é—´åˆ†é…": {{
       "score": 70,
       "å»ºè®®": [
           {{"ç¯èŠ‚": "å¯¼å…¥", "å»ºè®®æ—¶é•¿": "3-7åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
           {{"ç¯èŠ‚": "æ–°æˆ", "å»ºè®®æ—¶é•¿": "20-30åˆ†é’Ÿ", "æ˜¯å¦åˆç†": false}},
           {{"ç¯èŠ‚": "ç»ƒä¹ ", "å»ºè®®æ—¶é•¿": "7-13åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
           {{"ç¯èŠ‚": "æ€»ç»“", "å»ºè®®æ—¶é•¿": "2-4åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}},
           {{"ç¯èŠ‚": "ä½œä¸š", "å»ºè®®æ—¶é•¿": "1-3åˆ†é’Ÿ", "æ˜¯å¦åˆç†": true}}
       ]
   }},
   "ç´ å…»åŒ¹é…": {{
        "avg_score": 82.25,
        "å„ç´ å…»": {{
            "ä¿¡æ¯æ„è¯†": {{
                "åˆ†æ•°": 78.50,
                "ç›¸ä¼¼åº¦è®¡ç®—è¿‡ç¨‹": {{
                    "ä¼˜ç§€é”šç‚¹åŒ¹é…åº¦": 0.85,
                    "åŸºç¡€é”šç‚¹åŒ¹é…åº¦": 0.60,
                    "ç¼ºå¤±é”šç‚¹åŒ¹é…åº¦": 0.10,
                    "æƒé‡è®¡ç®—å…¬å¼": "0.85Ã—0.5 + 0.60Ã—0.3 + (1-0.10)Ã—0.2 = 0.785 â†’ 78.50åˆ†"
                }},
                "åŒ¹é…è¯æ®": [
                    "ä¼˜ç§€åŒ¹é…ï¼šæ•™æ¡ˆå†™'å¯¹æ¯”å®˜æ–¹ä¸è‡ªåª’ä½“ä¿¡æ¯' â†” é”šç‚¹'å¯¹æ¯”å®˜æ–¹åª’ä½“ä¸è‡ªåª’ä½“'",
                    "åŸºç¡€åŒ¹é…ï¼šæ•™æ¡ˆå†™'åŸ¹å…»ç”„åˆ«èƒ½åŠ›' â†” é”šç‚¹'åŸ¹å…»ä¿¡æ¯ç”„åˆ«æ„è¯†'",
                    "å·®å¼‚ç‚¹ï¼šæ•™æ¡ˆæœªæ˜ç¡®'è®°å½•åˆ¤æ–­ä¾æ®'ï¼ˆä¼˜ç§€é”šç‚¹è¦ç´ ï¼‰"
                ],
                "ç†ç”±": "æ•™æ¡ˆå…·å¤‡å®Œæ•´çš„ä¿¡æ¯å¯¹æ¯”æ´»åŠ¨ï¼ˆé«˜ç›¸ä¼¼åº¦ï¼‰ï¼Œä½†åœ¨å…ƒè®¤çŸ¥å±‚é¢ï¼ˆè®°å½•ä¾æ®ï¼‰ä¸è¶³ï¼Œæ•…å¾—78.50åˆ†è€Œéæ»¡åˆ†"
            }},
            "è®¡ç®—æ€ç»´": {{
                "åˆ†æ•°": 85.00,
                "ç›¸ä¼¼åº¦è®¡ç®—è¿‡ç¨‹": {{
                    "ä¼˜ç§€é”šç‚¹åŒ¹é…åº¦": 0.90,
                    "åŸºç¡€é”šç‚¹åŒ¹é…åº¦": 0.50,
                    "ç¼ºå¤±é”šç‚¹åŒ¹é…åº¦": 0.05,
                    "æƒé‡è®¡ç®—å…¬å¼": "0.90Ã—0.5 + 0.50Ã—0.3 + (1-0.05)Ã—0.2 = 0.45 + 0.15 + 0.19 = 0.79 â†’ 79.00åˆ†â†’è°ƒæ•´è‡³85åˆ†ï¼ˆå› å…·ä½“ä»»åŠ¡åˆ†è§£æ˜ç¡®ï¼‰"
                }},
                "åŒ¹é…è¯æ®": [
                    "æ•™æ¡ˆæ˜ç¡®æåˆ°æ­¥éª¤åˆ†è§£ä¸æµç¨‹å›¾ç»˜åˆ¶ï¼ˆå¯¹åº”ä¼˜ç§€é”šç‚¹ï¼‰"
                ],
                "ç†ç”±": "å…·å¤‡æ˜ç¡®çš„é—®é¢˜åˆ†è§£å’Œç®—æ³•æè¿°æ´»åŠ¨"
            }},
            "æ•°å­—åŒ–å­¦ä¹ ä¸åˆ›æ–°": {{
                "åˆ†æ•°": 75.00,
                "ç›¸ä¼¼åº¦è®¡ç®—è¿‡ç¨‹": {{
                    "ä¼˜ç§€é”šç‚¹åŒ¹é…åº¦": 0.70,
                    "åŸºç¡€é”šç‚¹åŒ¹é…åº¦": 0.80,
                    "ç¼ºå¤±é”šç‚¹åŒ¹é…åº¦": 0.20
                }},
                "åŒ¹é…è¯æ®": ["ä½¿ç”¨Wordåˆ¶ä½œå°æŠ¥ï¼ˆåŸºç¡€åŒ¹é…ï¼‰ï¼Œä½†æ— åœ¨çº¿åä½œï¼ˆç¼ºå¤±ä¼˜ç§€è¦ç´ ï¼‰"],
                "ç†ç”±": "åŸºç¡€å·¥å…·åº”ç”¨å……åˆ†ï¼Œä½†ç¼ºä¹åä½œåˆ›æ–°å…ƒç´ "
            }},
            "ä¿¡æ¯ç¤¾ä¼šè´£ä»»": {{
                "åˆ†æ•°": 92.00,
                "ç›¸ä¼¼åº¦è®¡ç®—è¿‡ç¨‹": {{
                    "ä¼˜ç§€é”šç‚¹åŒ¹é…åº¦": 0.95,
                    "åŸºç¡€é”šç‚¹åŒ¹é…åº¦": 0.40,
                    "ç¼ºå¤±é”šç‚¹åŒ¹é…åº¦": 0.05
                }},
                "åŒ¹é…è¯æ®": ["è®¨è®ºæŠ€æœ¯ä¼¦ç†å†²çªï¼Œåˆ¶å®šä¿æŠ¤å…¬çº¦ï¼ˆé«˜åº¦åŒ¹é…ä¼˜ç§€é”šç‚¹ï¼‰"],
                "ç†ç”±": "ä¼¦ç†è®¨è®ºæ·±å…¥ï¼Œä½“ç°ä¼˜ç§€æ°´å¹³"
            }}
        }}
   }}
}}

æ•™æ¡ˆæ–‡æœ¬ï¼š{text}
"""
    return model_invocation(prompt)

def score_lesson_plan(diagnosis_result):
    """æŒ‰æƒé‡è®¡ç®—ä¸‰ä¸ªç»´åº¦çš„æ€»åˆ†"""
    try:
        # å®‰å…¨è·å–åˆ†æ•°å€¼ï¼ˆé¿å…KeyErrorï¼‰
        section_score = diagnosis_result.get("ç¯èŠ‚å®Œæ•´æ€§", {}).get("score", 0)
        time_score = diagnosis_result.get("æ—¶é—´åˆ†é…", {}).get("score", 0)
        literacy_score = diagnosis_result.get("ç´ å…»åŒ¹é…", {}).get("avg_score", 0)  # ä¿®æ­£æ‹¼å†™ï¼šsocre -> score

        # åŠ æƒè®¡ç®—ï¼šç¯èŠ‚30% + æ—¶é—´30% + ç´ å…»40%
        total_score = section_score * 0.3 + time_score * 0.3 + literacy_score * 0.4
        return round(total_score, 2)  # ä¿ç•™2ä½å°æ•°
    except Exception as e:
        st.error(f"è¯„åˆ†è®¡ç®—å¤±è´¥: {str(e)}")
        return 0.0
# ---------------------- 4. å›¾å½¢åŒ–ç•Œé¢ï¼ˆä¸Šä¼ +æ˜¾ç¤ºç»“æœï¼‰----------------------
def Main_interface():
    st.set_page_config(page_title="æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ", layout="wide")
    st.title("ğŸ“š åˆä¸­ä¿¡æ¯ç§‘æŠ€æ•™æ¡ˆæ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ")
    st.write("ä¸Šä¼ TXTæ•™æ¡ˆæ–‡ä»¶ï¼Œè‡ªåŠ¨æ£€æµ‹è§„èŒƒæ€§å¹¶ç”Ÿæˆå»ºè®®ï¼")

    # ä¸Šä¼ æ–‡ä»¶ï¼ˆä»…æ”¯æŒTXTï¼Œé¿å…PDFä¹±ç ï¼‰
    File_Upload = st.file_uploader("é€‰æ‹©æ•™æ¡ˆæ–‡ä»¶ï¼ˆTXTæ ¼å¼ï¼‰", type=["txt"], key="uploader")

    if File_Upload:
        # è¯»å–TXTå†…å®¹ï¼ˆUTF-8ç¼–ç é˜²ä¹±ç ï¼‰
        try:
            text = File_Upload.read().decode("utf-8")
        except:
            st.error("æ–‡ä»¶ç¼–ç é”™è¯¯ï¼è¯·ç”¨è®°äº‹æœ¬æ‰“å¼€æ•™æ¡ˆï¼Œå¦å­˜ä¸ºUTF-8æ ¼å¼TXT")
            return

        if len(text.strip()) < 100:
            st.warning("æ•™æ¡ˆå†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½æ— æ³•å‡†ç¡®æ£€æµ‹ï¼")
            return

        # è°ƒç”¨æ£€æµ‹åŠŸèƒ½
        with st.spinner("å¤§æ¨¡å‹åˆ†æä¸­...ï¼ˆçº¦10ç§’ï¼‰"):
            result = test_lesson_plan(text)

        # æ˜¾ç¤ºç»“æœ
        st.subheader("ğŸ“Š è¯Šæ–­ç»“æœï¼ˆJSONæ ¼å¼ï¼‰")
        st.json(result)  # ç»“æ„åŒ–å±•ç¤º
        # è®¡ç®—æ€»åˆ†
        total_score = score_lesson_plan(result)
        # æå–å„ç»´åº¦åˆ†æ•°
        section_score = result.get("ç¯èŠ‚å®Œæ•´æ€§", {}).get("score", 0)
        time_score = result.get("æ—¶é—´åˆ†é…", {}).get("score", 0)
        literacy_score = result.get("ç´ å…»åŒ¹é…", {}).get("avg_score", 0)
        # æ˜¾ç¤ºåˆ†æ•°å¡ç‰‡
        st.subheader("ğŸ“ˆ æ•™æ¡ˆè¯„åˆ†")

        # åˆ›å»ºåˆ†æ•°å¡ç‰‡å¸ƒå±€
        col1, col2, col3, col4 = st.columns(4)

        # ç¯èŠ‚å®Œæ•´æ€§å¡ç‰‡
        col1.metric(
            label="ç¯èŠ‚å®Œæ•´æ€§",
            value=f"{section_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°å¯¼å…¥/æ–°æˆ/ç»ƒä¹ /æ€»ç»“/ä½œä¸š5ç¯èŠ‚æ˜¯å¦é½å…¨æœ‰æ•ˆ"
        )

        # æ—¶é—´åˆ†é…å¡ç‰‡
        col2.metric(
            label="æ—¶é—´åˆ†é…",
            value=f"{time_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°å„ç¯èŠ‚æ—¶é•¿æ˜¯å¦ç¬¦åˆ45åˆ†é’Ÿè¯¾ç¨‹è¦æ±‚"
        )

        # æ ¸å¿ƒç´ å…»å¡ç‰‡
        col3.metric(
            label="æ ¸å¿ƒç´ å…»",
            value=f"{literacy_score}åˆ†",
            help="æ»¡åˆ†100åˆ†ï¼Œè¯„ä¼°ä¿¡æ¯æ„è¯†/è®¡ç®—æ€ç»´ç­‰å››å¤§ç´ å…»è¦†ç›–åº¦"
        )

        # æ€»åˆ†å¡ç‰‡ï¼ˆçªå‡ºæ˜¾ç¤ºï¼‰
        col4.metric(
            label="ğŸ† æ•™æ¡ˆæ€»åˆ†",
            value=f"{total_score}åˆ†",
            help="åŠ æƒè®¡ç®—ï¼šç¯èŠ‚30% + æ—¶é—´30% + ç´ å…»40%"
        )

        # æ·»åŠ è¿›åº¦æ¡å¯è§†åŒ–
        st.progress(int(total_score), text=f"æ•™æ¡ˆç»¼åˆè¯„åˆ†ï¼š{total_score}/100åˆ†")

                # ç”Ÿæˆæ–‡å­—å»ºè®®ï¼ˆç›´æ¥è°ƒç”¨APIï¼Œä¸å¼ºåˆ¶JSONæ ¼å¼ï¼‰
        suggestions_prompt = f"æ ¹æ®è¯Šæ–­ç»“æœ{result}ï¼Œç»™è€å¸ˆå†™3æ¡å…·ä½“ä¿®æ”¹å»ºè®®ï¼ˆç®€æ´æ˜äº†ï¼Œç”¨1. 2. 3.ç¼–å·ï¼‰ï¼š"
        
        try:
            # ç›´æ¥è°ƒç”¨APIï¼Œä¸ç»è¿‡model_invocationçš„JSONè§£æ
            response = client.chat.completions.create(
                model="glm-4",
                messages=[{"role": "user", "content": suggestions_prompt}],
                temperature=0.7,  # å»ºè®®éƒ¨åˆ†å¯ä»¥ç¨å¾®æœ‰åˆ›æ„ä¸€äº›
                max_tokens=1000
            )
            text_suggestions = response.choices[0].message.content
        except Exception as e:
            text_suggestions = f"ç”Ÿæˆå»ºè®®æ—¶å‡ºé”™ï¼š{str(e)}"
        
        st.subheader("ğŸ’¡ è€å¸ˆä¿®æ”¹å»ºè®®")
        st.info(text_suggestions)  # è“è‰²èƒŒæ™¯çªå‡ºæ˜¾ç¤º


# ---------------------- è¿è¡Œç•Œé¢ ----------------------
if __name__ == "__main__":

    Main_interface()  # å¯åŠ¨å›¾å½¢ç•Œé¢




